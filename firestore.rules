
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users can read/write their own user profile
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth.uid != null;
    }

    // Quizzes can be read by anyone, but only created/modified by the owner (parent)
    match /quizzes/{quizId} {
      allow read: if request.auth.uid != null;
      allow create, update, delete: if request.auth.uid == resource.data.userId;
    }
    
    // Preloaded quizzes are read-only for any authenticated user
    match /preloadedQuizzes/{quizId} {
      allow read: if request.auth.uid != null;
      allow write: if false; // Nobody can write to preloaded quizzes from the client
    }
    
    // Quiz attempts can be created by the user taking the quiz, and read by that user or their parent
    match /quizAttempts/{attemptId} {
      allow create: if request.auth.uid == request.resource.data.userId;
      // Allow read if you are the user who made the attempt OR you are the parent of that user
      allow read: if request.auth.uid == resource.data.userId || get(/databases/$(database)/documents/users/$(resource.data.userId)).data.parentId == request.auth.uid;
      allow update, delete: if false; // Attempts are immutable
    }
    
    // Achievements can be read by the user or their parent, but only created by the server
    match /userAchievements/{achievementId} {
      allow create: if false; // Locked down - only server can create
      allow read: if request.auth.uid == resource.data.userId || get(/databases/$(database)/documents/users/$(resource.data.userId)).data.parentId == request.auth.uid;
      allow update, delete: if false;
    }
  }
}
